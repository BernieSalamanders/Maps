<!DOCTYPE html>
<head>
<title>Winnakee D3</title>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>

<script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script src="http://code.jquery.com/jquery-1.11.0.min.js" type="text/javascript"></script>
<script src="d3tip.js"></script>
<script src="http://cdn.leafletjs.com/leaflet-0.6.1/leaflet.js"></script>
<link rel="stylesheet" href="style.css">
</head>

<body>
    
    <h3>D3 Mapping Test</h3>
<script>


var width = ($(window).width()*.90)-27;
    height = $(window).height()*.90;
	active = d3.select(null);
	
// var tooltip = d3.select("body")
// 	.append("div")
// 	.style("position", "absolute")
// 	.style("z-index", "10")
// 	.style("visibility", "hidden")
// 	.text("Winakee Parcel");
    
 
var tip = d3.tip()
  .attr('class', 'd3-tip')
  .offset([-10, 0])
  .html(function(d) {
    return d.properties.sitename;
  }); 
    
var color = d3.scale.category20();

var projection = d3.geo.mercator()
    .center([-73.861544,41.913874 ])
    .scale(80000)
    .translate([width / 2, height / 2])
	
var path = d3.geo.path()
	.projection(projection);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

svg.call(tip);


svg.append("rect")
	.attr("class", "background")
	.attr('width', width)
	.attr('height', height)
	.on("click", reset);
    
	
var g = svg.append("g")
    .style("stroke-width", "1.5px");
	
d3.json("winnakee_v3.json", function(error, winnakee) {
  if (error) return console.error(error);
  console.log(winnakee);
	
       g.append("image")
  .attr("xlink:href", "sat.jpg")
  .attr({ width: width ,height: height })
  .attr("class", "bg");  
    
   g.selectAll("path")
      .data(topojson.feature(winnakee, winnakee.objects.winnakee_shape_to_geojson).features)
      .enter()
      .append("path")
      .attr("id", "property")
      .attr("d", path)
      .attr("class", function(d) { return d.properties.sitename; })
      .on("click", clicked)
      .on("mouseover", function(d){return tooltip.style("visibility", "visible");})
	  .on("mouseover", function(d) { tip.show(d, document.getElementById("head")) })
      .on("mouseout", tip.hide);
;

  g.append("path")
      .datum(topojson.mesh(winnakee, winnakee.objects.winnakee_shape_to_geojson, function(a, b) { return a !== b; }))
      .attr("class", "mesh")
      .attr("d", path);   
       
//   g.selectAll("text")
//     .data(topojson.feature(winnakee, winnakee.objects.winnakee_shape_to_geojson).features)
//     .enter()
//     .append("svg:text")
//     .text(function(d) { return d.properties.sitename; })
//     .attr("x", function(d){
//         return path.centroid(d)[0];
//     })
//     .attr("y", function(d){
//         return  path.centroid(d)[1];
//     })
//     .attr("text-anchor","middle")
//     .style("font-size", "1px");

});

function clicked(d) {
  if (active.node() === this) return reset();
  active.classed("active", false);
  active = d3.select(this).classed("active", true);

  var bounds = path.bounds(d),
      dx = bounds[1][0] - bounds[0][0],
      dy = bounds[1][1] - bounds[0][1],
      x = (bounds[0][0] + bounds[1][0]) / 2,
      y = (bounds[0][1] + bounds[1][1]) / 2,
      scale = .9 / Math.max(dx / width, dy / height),
      translate = [width / 2 - scale * x, height / 2 - scale * y];

  g.transition()
      .duration(750)
      .style("stroke-width", 1.5 / scale + "px")
      .attr("transform", "translate(" + translate + ")scale(" + scale + ")");
}

function reset() {
  active.classed("active", false);
  active = d3.select(null);

  g.transition()
      .duration(750)
      .style("stroke-width", "1.5px")
      .attr("transform", "");
}
	
</script>